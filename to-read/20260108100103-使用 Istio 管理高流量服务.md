---
type: "to-read"
id: 20260108100103
created: 2026-01-08T10:01:03
source:
  - "https://mp.weixin.qq.com/s/H4xOOzDgpXzH-HeMCQFUBQ"
tags:
reviewd: false
---
CNCF *2026年1月8日 09:50*

![Image](https://mmbiz.qpic.cn/mmbiz_png/GpkQxibjhkJzEjriatCbIKesZcdprb0PNCVSnRV6hMgszKXCZWUgxOPTugr0kMicLKArDXPs1Nv4HBR3R2PI0gAEw/640?wx_fmt=png&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1#imgIndex=0)

作者：Ihyeok Song，STCLab SRE 团队

在 STCLab，我们运营着高流量的 SaaS 平台，需要实时流量控制和机器人防护。应对数百万并发连接并实时识别恶意机器人，对基础设施稳定性要求极高。为此，我们依赖 Istio。

虽然 Istio 功能丰富，本文重点介绍在生产环境中最关键的几个能力。无论你是正在评估 Istio，还是寻找实用案例，希望这些经验对你有所帮助。

## 为什么选择 Istio？

Istio 作为控制平面，管理与容器并行部署的 Envoy 代理。每条 Istio 配置（VirtualService、DestinationRule、AuthorizationPolicy）都会转成 Envoy 原生配置。

这点很重要，原因有二：Istio 的抽象能优雅地应对大多数场景；不够用时，EnvoyFilter 可直接调用 Envoy 的底层能力。我们在基础设施中两者兼用。

## 利用 Proxy Protocol 保留真实客户端 IP

对我们的机器人防护平台，准确的客户端 IP 是关键。没有它，机器人检测准确率大幅下降。

挑战是：流量经过 AWS NLB 时，原始客户端 IP 会丢失。我们通过 EnvoyFilter 使用 Proxy Protocol 解决了这个问题：

![Image](https://mp.weixin.qq.com/s/www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg%20stroke='none'%20stroke-width='1'%20fill='none'%20fill-rule='evenodd'%20fill-opacity='0'%3E%3Cg%20transform='translate(-249.000000,%20-126.000000)'%20fill='%23FFFFFF'%3E%3Crect%20x='249'%20y='126'%20width='1'%20height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

> 备注：想深入了解源 IP 保留与网络拓扑配置，强烈建议参考 Istio 官方博客《Configuring Gateway Network Topology》。

我们还优先使用 X-Envoy-External-Address 头部替代 X-Forwarded-For，用于安全关键操作。该头由 Envoy 设置，外部客户端无法伪造。

## 基于 IP 的访问控制

内部 API（如 Swagger 文档）需要保护。我们用 AuthorizationPolicy 限制只允许办公 IP 访问：

![Image](https://mp.weixin.qq.com/s/www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg%20stroke='none'%20stroke-width='1'%20fill='none'%20fill-rule='evenodd'%20fill-opacity='0'%3E%3Cg%20transform='translate(-249.000000,%20-126.000000)'%20fill='%23FFFFFF'%3E%3Crect%20x='249'%20y='126'%20width='1'%20height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

DENY 配合 notRemoteIpBlocks 实现白名单，只有明确允许的 IP 才能访问，简单有效。

## 基于查询参数的路由

我们的内部流量管理平台管理内存中的队列状态。每个租户的请求必须路由到同一后端实例，保持状态一致。

我们通过查询参数实现显式路由：

![Image](https://mp.weixin.qq.com/s/www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg%20stroke='none'%20stroke-width='1'%20fill='none'%20fill-rule='evenodd'%20fill-opacity='0'%3E%3Cg%20transform='translate(-249.000000,%20-126.000000)'%20fill='%23FFFFFF'%3E%3Crect%20x='249'%20y='126'%20width='1'%20height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

为何不直接用自动哈希：

这是和应用团队协作的结果。客户端通过 sticky 参数指定目标实例，带来：

- 确定性路由：客户端明确知道请求由哪个实例处理
- 问题隔离：将有问题的租户路由到特定实例，方便排查
- 平滑迁移：维护期间可迁移租户实例

替代方案：一致性哈希

对于不需要严格一致性的服务，我们用一致性哈希：

![Image](https://mp.weixin.qq.com/s/www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg%20stroke='none'%20stroke-width='1'%20fill='none'%20fill-rule='evenodd'%20fill-opacity='0'%3E%3Cg%20transform='translate(-249.000000,%20-126.000000)'%20fill='%23FFFFFF'%3E%3Crect%20x='249'%20y='126'%20width='1'%20height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

自动将相同 tenant\_id 的请求路由至同一后端。我们对虚拟候客室核心队列服务用显式路由，辅助服务则用一致性哈希。

## 使用 Outlier Detection 作自动故障隔离

一个不健康的 pod 可能拖垮整个服务。我们用 Outlier Detection 自动剔除异常实例：

![Image](https://mp.weixin.qq.com/s/www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg%20stroke='none'%20stroke-width='1'%20fill='none'%20fill-rule='evenodd'%20fill-opacity='0'%3E%3Cg%20transform='translate(-249.000000,%20-126.000000)'%20fill='%23FFFFFF'%3E%3Crect%20x='249'%20y='126'%20width='1'%20height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

工作原理：

- 连续 5 次 5xx 响应后剔除 pod
- 剔除后 pod 至少隔离 30 秒
- 不会剔除超过 50% 的 pod，保障可用性

实际效果：最近一次部署时一个 pod 进入崩溃循环，Outlier Detection 在 50 秒内剔除它，流量自动切换到健康 pod，无需人工干预。

## 长连接的优雅关闭

我们的网关处理超过 10 分钟的长连接。部署时若强制断开，会导致测试失败。

关键规则：terminationGracePeriodSeconds 必须大于 terminationDrainDuration。

![Image](https://mp.weixin.qq.com/s/www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg%20stroke='none'%20stroke-width='1'%20fill='none'%20fill-rule='evenodd'%20fill-opacity='0'%3E%3Cg%20transform='translate(-249.000000,%20-126.000000)'%20fill='%23FFFFFF'%3E%3Crect%20x='249'%20y='126'%20width='1'%20height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

  

![Image](https://mp.weixin.qq.com/s/www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg%20stroke='none'%20stroke-width='1'%20fill='none'%20fill-rule='evenodd'%20fill-opacity='0'%3E%3Cg%20transform='translate(-249.000000,%20-126.000000)'%20fill='%23FFFFFF'%3E%3Crect%20x='249'%20y='126'%20width='1'%20height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

  

![Image](https://mp.weixin.qq.com/s/www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg%20stroke='none'%20stroke-width='1'%20fill='none'%20fill-rule='evenodd'%20fill-opacity='0'%3E%3Cg%20transform='translate(-249.000000,%20-126.000000)'%20fill='%23FFFFFF'%3E%3Crect%20x='249'%20y='126'%20width='1'%20height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

  

关闭流程：

1. Pod 收到终止信号
2. Envoy 停止接收新连接，健康检查失败
3. 现有连接最多保持 terminationDrainDuration（600 秒）
4. 开启 EXIT\_ON\_ZERO\_ACTIVE\_CONNECTIONS 时，连接快速关闭，Pod 提前退出
5. Kubernetes 在 terminationGracePeriodSeconds（660 秒）后发送 SIGKILL

结果：

- 部署期间零连接断开
- 滚动更新时负载测试顺利完成

## 生产实践要点

以下是使用 Istio 扩展时的经验建议：

- 从简单开始：不要一开始就开启所有功能，只有业务需求明确时才加入复杂功能（如 mTLS、Tracing）
- 注意指标维度：Envoy 产生海量遥测数据，可能导致 Prometheus 崩溃，需精细调优采集指标
- 小心使用 EnvoyFilter：它功能强大但升级时易出问题，必须严格文档和兼容性测试

## 总结

Istio 有学习曲线，但对我们的高流量平台来说，带来的控制力极具价值。本文介绍的 Proxy Protocol 保留客户端 IP，AuthorizationPolicy 做访问控制，灵活路由策略，Outlier Detection 保证韧性，以及优雅关闭长连接，已成基础设施不可或缺的部分。

如果你的服务对流量管理、安全和可靠性有高要求，Istio 非常值得尝试。

  

点击【阅读原文】阅读网站原文 。

  

[![Image](https://mp.weixin.qq.com/s/www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg%20stroke='none'%20stroke-width='1'%20fill='none'%20fill-rule='evenodd'%20fill-opacity='0'%3E%3Cg%20transform='translate(-249.000000,%20-126.000000)'%20fill='%23FFFFFF'%3E%3Crect%20x='249'%20y='126'%20width='1'%20height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)](https://mp.weixin.qq.com/s?__biz=MzI5ODk5ODI4Nw==&mid=2247557278&idx=1&sn=a9dc0db8d77631fc73634d5b4dab23c8&scene=21#wechat_redirect)

立即下载赞助商企划书（https://cncf.io/sponsor）了解赞助方案和市场推广机会。

![Image](https://mp.weixin.qq.com/s/www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg%20stroke='none'%20stroke-width='1'%20fill='none'%20fill-rule='evenodd'%20fill-opacity='0'%3E%3Cg%20transform='translate(-249.000000,%20-126.000000)'%20fill='%23FFFFFF'%3E%3Crect%20x='249'%20y='126'%20width='1'%20height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

CNCF概况（幻灯片）

![Image](https://mp.weixin.qq.com/s/www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg%20stroke='none'%20stroke-width='1'%20fill='none'%20fill-rule='evenodd'%20fill-opacity='0'%3E%3Cg%20transform='translate(-249.000000,%20-126.000000)'%20fill='%23FFFFFF'%3E%3Crect%20x='249'%20y='126'%20width='1'%20height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

扫描二维码联系我们！

  

---

  

***CNCF (Cloud Native Computing Foundation)成立于2015年12月，隶属于Linux Foundation，是非营利性组织。***

******CNCF****** ***（*** ******云原生计算基金会*** ）致力于培育和维护一个厂商中立的开源生态系统，来推广云原生技术。我们通过将最前沿的模式民主化，让这些创新为大众所用。请关注CNCF微信公众号。***

[Read more](https://mp.weixin.qq.com/s/)

继续滑动看下一个

CNCF

向上滑动看下一个