---
type: "to-read"
id: 20251227081213
created: 2025-12-27T08:59:13
source:
  - "https://mp.weixin.qq.com/s/-lV1b0j2OoSXmtJjSKPdGw"
tags:
reviewd: false
---
Original bearix *2025å¹´12æœˆ24æ—¥ 18:15*

> Hiï¼Œå¤§å®¶å¥½ï¼Œæˆ‘æ˜¯ Sealos çš„åŸºç¡€æ¶æ„å·¥ç¨‹å¸ˆ bearixï½ã€‚
> 
> ![Image](https://mmbiz.qpic.cn/mmbiz_jpg/ynf3LgZ9ibZrrZha0M3lByxUbTqCyLaP0mbZkn3KIBYtkiauvkibIpnwvCmsEP0QLD9D0dqYsTcLtFoRyiaiaqUeqibQ/640?wx_fmt=jpeg&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1#imgIndex=0)
> 
> äº‘è®¡ç®—åœºæ™¯é‡Œï¼Œ **æ•°æ®åº“æ—¥å¿—æ”¶é›†** ä¸€ç›´æ˜¯ä¸ªè®©äººå¤´ç–¼çš„éš¾é¢˜ï¼šæ™®é€šåº”ç”¨æ—¥å¿—å¯ä»¥ç›´æ¥è¾“å‡ºåˆ° stdout/stderrï¼Œä½†æ•°æ®åº“æ—¥å¿—å¾€å¾€å­˜åœ¨æŒä¹…åŒ–å­˜å‚¨å·é‡Œï¼Œä¼ ç»Ÿçš„æ—¥å¿—æ”¶é›†æ–¹æ¡ˆæ ¹æœ¬æ²¡æ³•ç›´æ¥å¥—ç”¨ã€‚
> 
> æœ€å¼€å§‹æˆ‘ä»¬è€ƒè™‘è¿‡å¸¸ç”¨çš„ **sidecar æ¨¡å¼** æ¥å¤„ç†è¿™ç±»éæ ‡å‡†è¾“å‡ºæ—¥å¿—ï¼Œä½†å®ƒä¼šå¤§å¹…å¢åŠ èŠ‚ç‚¹å†…å­˜æ¶ˆè€—ï¼Œè¿˜å’Œç°æœ‰ç®¡æ§ä½“ç³»å†²çªï¼Œåªèƒ½æ”¾å¼ƒã€‚
> 
> ç»è¿‡å¤šè½®æŠ€æœ¯éªŒè¯å’Œæ–¹æ¡ˆæ‰“ç£¨ï¼Œæˆ‘ä»¬ç»ˆäºæå‡ºäº†ä¸€å¥—å…¼é¡¾ **é«˜æ€§èƒ½å†™å…¥ã€é«˜ç²¾åº¦æŸ¥è¯¢ã€é«˜å¯ç”¨ä¿éšœçš„æ•°æ®åº“æ—¥å¿—æ”¶é›†æ–¹æ¡ˆ** ï¼Œä»Šå¤©å°±æ¥è·Ÿå¤§å®¶åˆ†äº«å…·ä½“çš„å®ç°è¿‡ç¨‹å’ŒæŠ€æœ¯ç»†èŠ‚ã€‚

## æ ¸å¿ƒé—®é¢˜æ‹†è§£

åœ¨å¼€å§‹æ–¹æ¡ˆè®¾è®¡å‰ï¼Œæˆ‘ä»¬å…ˆæ˜ç¡®äº†éœ€è¦è§£å†³çš„ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š

**1\. é«˜æ€§èƒ½å†™å…¥ï¼š** æ•°æ®åº“æ—¥å¿—æ–‡ä»¶è·¯å¾„åˆ†æ•£ä¸”æ ¼å¼ä¸ç»Ÿä¸€ï¼Œå¦‚ä½•é«˜æ•ˆå®šä½æ—¥å¿—æ–‡ä»¶ï¼ŒåŒæ—¶é¿å…å› éå†å¤§é‡æ— å…³æ–‡ä»¶å¯¼è‡´é‡‡é›†å™¨å´©æºƒã€‚

**2\. é«˜ç²¾åº¦æŸ¥è¯¢ï¼š** æ—¥å¿—æ–‡ä»¶è·¯å¾„ä¸­åªæœ‰ `pod id` å’Œ `pvc id` ï¼Œç¼ºå°‘ namespaceã€æ•°æ®åº“åç§°ç­‰å…³é”®å…ƒæ•°æ®ï¼Œæ— æ³•å®ç°åº”ç”¨çº§çš„ç²¾å‡†æ—¥å¿—æ£€ç´¢ã€‚

**3\. é«˜å¯ç”¨å»ºè®¾ï¼š** é¢å¯¹æ•°æ®åº“é‡å¯ã€fluent-bité‡å¯ã€æ—¥å¿—å­˜å‚¨æœåŠ¡é‡å¯ç­‰å¤æ‚åœºæ™¯ï¼Œå¦‚ä½•ä¿è¯æ—¥å¿—ä¸ä¸¢å¤±ã€ä¸é‡å¤é‡‡é›†ã€‚

## é—®é¢˜ä¸€ï¼šé«˜æ€§èƒ½å†™å…¥

æˆ‘ä»¬çš„æ•°æ®åº“æ—¥å¿—éƒ½å­˜å‚¨åœ¨PVCä¸­ï¼Œåœ¨èŠ‚ç‚¹ä¸Šçš„è·¯å¾„æ ¼å¼å„æœ‰ä¸åŒã€‚æ¯”å¦‚mysqlæ—¥å¿—è·¯å¾„

```
# mysql
/var/lib/kubelet/pods/2fb6fbc6-dfd4-4888-854b-51c09b65a668/volumes/kubernetes.io~csi/pvc-bac37387-6a2f-42d2-8fe2-b1976db48919/mount/log/xxx.log
# pg
/var/lib/kubelet/pods/59f94306-e2da-4229-b5d3-82f960632f26/volumes/kubernetes.io~csi/pvc -4812e91a-84e4-4768-b359-8709bf7e89f8/mount/pgroot/pg_log/xxx.csv
# mongo
/var/lib/kubelet/pods/b3d84394-d4c5-4039-9769-4791c85213bd/volumes/kubernetes.io~csi/pvc-933aa6aa-ee2d-4d16-8d52-8f557457a286/mount/logs/mongodb.log
# redis
/var/lib/kubelet/pods/2761f024-19f3-4424-9ea6-7c1b57e1cb25/volumes/kubernetes.io~csi/pvc-3c55dac2-bd2a-4072-9493-aacf7c0352b7/mount/running.log
```

ä¸ºäº†é«˜æ•ˆé‡‡é›†è¿™äº›æ—¥å¿—ï¼Œæˆ‘ä»¬é€‰æ‹©äº† **fluent-bitçš„tailæ’ä»¶** ã€‚å…·ä½“æ“ä½œæ˜¯å°†èŠ‚ç‚¹çš„/var/lib/kubelet/podsç›®å½•æŒ‚è½½åˆ°fluent-bitå®¹å™¨ä¸­ï¼Œå¹¶è®¾ç½® `mountPropagation` ä¸º `HostToContainer` ï¼Œç¡®ä¿æ•°æ®åº“å®¹å™¨å†…çš„æ—¥å¿—å˜æ›´èƒ½å®æ—¶åŒæ­¥åˆ°fluent-bitå®¹å™¨ï¼ŒåŒæ—¶å®ç°æƒé™æœ€å°åŒ–ã€‚

ä½†æ–°çš„é—®é¢˜å‡ºç°äº†ï¼šå…¬æœ‰äº‘åœºæ™¯ä¸‹ç”¨æˆ·çš„PVCä¸­å¯èƒ½å­˜åœ¨å¤§é‡æ— å…³æ–‡ä»¶ï¼Œå¦‚æœç›´æ¥ç”¨æ­£åˆ™è¡¨è¾¾å¼éå†æ‰€æœ‰PVCå†…å®¹ï¼Œé‡‡é›†å™¨å¾ˆå®¹æ˜“å› ä¸ºæ–‡ä»¶æ•°é‡è¿‡å¤šè€Œå´©æºƒã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬æ·±å…¥ç ”ç©¶äº† **fluent-bit tailæ’ä»¶çš„æ ¸å¿ƒåŒ¹é…é€»è¾‘** ï¼štailæ’ä»¶ä»£ç ä½äº/fluent-bit/plugins/in\_tail/tail.cä¸­ï¼Œæ¶‰åŠåˆ°çš„å‡½æ•°è°ƒç”¨é“¾è·¯å¦‚ä¸‹ï¼š

```
ç”¨æˆ·é…ç½®: path = /var/log/*.log
    â†“
flb_tail_scan()
    â†“ éå†è·¯å¾„åˆ—è¡¨
tail_scan_path()
    â†“ å¯¹æ¯ä¸ªè·¯å¾„æ¨¡å¼
do_glob()
    â†“ å¤„ç†æ³¢æµªå·å±•å¼€
ç³»ç»Ÿ glob() å‡½æ•° â† è¿™é‡Œæ˜¯çœŸæ­£çš„åŒ¹é…é€»è¾‘
    â†“ è¿”å›åŒ¹é…ç»“æœ
å¤„ç† globbuf.gl_pathv[] æ•°ç»„
```

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ Fluent Bit çš„ä»£ç ä¸­ï¼Œæ ¸å¿ƒçš„ glob åŒ¹é…é€»è¾‘å¹¶ä¸æ˜¯è‡ªå·±å®ç°çš„ï¼Œè€Œæ˜¯è°ƒç”¨ç³»ç»Ÿæä¾›çš„æ ‡å‡†åº“ã€‚ é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹ glob æ ‡å‡†åº“ï¼š

```
root@lst-test:~#ldd --version
ldd (Ubuntu GLIBC 2.35-0ubuntu3.10) 2.35
Copyright (C) 2022 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
Written by Roland McGrath and Ulrich Drepper.
```

å¯ä»¥çœ‹åˆ°ä½¿ç”¨çš„æ˜¯ **GNU libc** ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŸ¥çœ‹äº† **GNU libc glob çš„æºä»£ç ** ï¼Œå…¶æ ¸å¿ƒä»£ç ä½äº `https://github.com/bminor/glibc/blob/master/posix/glob.c` ã€‚

åˆ†æåå‘ç°ï¼Œglob å‡½æ•°é‡‡ç”¨ **"åˆ†è€Œæ²»ä¹‹" çš„ç­–ç•¥** ï¼Œå°†è·¯å¾„æ¨¡å¼åˆ†è§£ä¸ºç›®å½•éƒ¨åˆ†å’Œæ–‡ä»¶åéƒ¨åˆ†ï¼Œç„¶ååˆ†åˆ«å¤„ç†ã€‚æ ¸å¿ƒæ€æƒ³æ˜¯ä»å³åˆ°å·¦é€æ­¥è§£æè·¯å¾„ï¼Œå…ˆå¤„ç†æœ€åä¸€ä¸ªæ–œæ åçš„æ–‡ä»¶åæ¨¡å¼ï¼Œå†å¤„ç†ç›®å½•éƒ¨åˆ†ã€‚

å‡½æ•°é¦–å…ˆä½¿ç”¨ `strrchrÂ ` æ‰¾åˆ°æ¨¡å¼ä¸­æœ€åä¸€ä¸ªæ–œæ çš„ä½ç½®ï¼Œä»¥æ­¤ä¸ºç•Œå°†å®Œæ•´è·¯å¾„åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šç›®å½•è·¯å¾„å’Œæ–‡ä»¶åæ¨¡å¼ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ–œæ ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æ–‡ä»¶åæ¨¡å¼ï¼Œç›®å½•é»˜è®¤ä¸ºå½“å‰ç›®å½•ã€‚

å‡½æ•°ä¼šæ£€æŸ¥ç›®å½•éƒ¨åˆ†æ˜¯å¦åŒ…å«é€šé…ç¬¦ã€‚å¦‚æœç›®å½•éƒ¨åˆ†åŒ…å«é€šé…ç¬¦ï¼Œå°±éœ€è¦å…ˆåŒ¹é…ç›®å½•ï¼š

- é€’å½’è°ƒç”¨ glob å‡½æ•°åŒ¹é…ç›®å½•æ¨¡å¼
- è·å¾—æ‰€æœ‰åŒ¹é…çš„ç›®å½•åˆ—è¡¨
- å¯¹æ¯ä¸ªåŒ¹é…çš„ç›®å½•ï¼Œè°ƒç”¨ **glob\_in\_dir** å‡½æ•°åœ¨å…¶ä¸­æœç´¢æ–‡ä»¶åæ¨¡å¼

å¦‚æœç›®å½•éƒ¨åˆ†ä¸åŒ…å«é€šé…ç¬¦ï¼Œåˆ™ç›´æ¥åœ¨æŒ‡å®šç›®å½•ä¸­è°ƒç”¨glob\_in\_diræœç´¢æ–‡ä»¶ã€‚

æ¥ä¸‹æ¥æŸ¥çœ‹æœ€é‡è¦çš„ **glob\_in\_dirå‡½æ•°** ï¼Œå…¶æ ¸å¿ƒé€»è¾‘å¯ä»¥ä½¿ç”¨ä¼ªä»£ç è¡¨è¿°å¦‚ä¸‹ï¼š

```
static intglob_in_dir (const char *pattern, const char *directory, int flags,int (*errfunc) (const char *, int),glob_t *pglob, size_t alloca_used){//åˆ¤æ–­å½“å‰å±‚çº§ç›®å½•ä¸­æ˜¯å¦æœ‰é€šé…ç¬¦
  meta = __glob_pattern_type (pattern, !(flags & GLOB_NOESCAPE));if (meta == GLOBPAT_NONE && (flags & (GLOB_NOCHECK|GLOB_NOMAGIC))){
      flags |= GLOB_NOCHECK;}//å¦‚æœé€šé…ç¬¦ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨else if (meta == GLOBPAT_NONE){//if (glob_lstat (pglob, flags, fullname) == 0|| errno == EOVERFLOW)/* We found this file to be existing.  Now tell the rest
           of the function to copy this name into the result.  */
        flags |= GLOB_NOCHECK;if (__glibc_unlikely (!alloca_fullname))free (fullname);}else//å¦‚æœé€šé…ç¬¦å­˜åœ¨ï¼Œåˆ™å¾ªç¯éå†æ‰€æœ‰æ–‡ä»¶{while (1){}}}
```

å¯ä»¥çœ‹åˆ°ï¼Œ **å½“æ–‡ä»¶åä¸åŒ…å«é€šé…ç¬¦æ—¶ï¼Œglob å‡½æ•°ä¼šç›´æ¥éªŒè¯è¯¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œè€Œä¸ä¼šéå†ç›®å½•** ã€‚

è¿™æ—¶å†è€ƒè™‘æˆ‘ä»¬çš„æ•°æ®åº“ç›®å½•å’ŒåŒ¹é…ç›®å½•ï¼š

```
# mysql
/var/lib/kubelet/pods/2fb6fbc6-dfd4-4888-854b-51c09b65a668/volumes/kubernetes.io~csi/pvc-bac37387-6a2f-42d2-8fe2-b1976db48919/mount/log/xxx.log
# pg
/var/lib/kubelet/pods/59f94306-e2da-4229-b5d3-82f960632f26/volumes/kubernetes.io~csi/pvc-4812e91a-84e4-4768-b359-8709bf7e89f8/mount/pgroot/pg_log/xxx.csv
# mongo
/var/lib/kubelet/pods/b3d84394-d4c5-4039-9769-4791c85213bd/volumes/kubernetes.io~csi/pvc-933aa6aa-ee2d-4d16-8d52-8f557457a286/mount/logs/mongodb.log
# redis
/var/lib/kubelet/pods/2761f024-19f3-4424-9ea6-7c1b57e1cb25/volumes/kubernetes.io~csi/pvc-3c55dac2-bd2a-4072-9493-aacf7c0352b7/mount/running.log
```

ä¸ºäº†é˜²æ­¢PVCåŒ¹é…ç›®å½•è¿‡å¤šï¼Œåªè¦æˆ‘ä»¬åœ¨åˆšè¿›å…¥PVCçš„ç¬¬ä¸€ä¸ªç›®å½•è¿™é‡Œä¸ä½¿ç”¨é€šé…ç¬¦ï¼Œè€Œæ˜¯ä½¿ç”¨ **å›ºå®šç›®å½•** ï¼Œå°±å¯ä»¥é¿å…fluent-bit éå†å…¨éƒ¨PVCç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œå¤§å¤§ä¼˜åŒ–æ€§èƒ½ã€‚

å³ï¼š

```
/var/lib/kubelet/pods/*/volumes/kubernetes.io~csi/*/mount/å›ºå®šç›®å½•/*.log
```

å¦‚æœæƒ³è¦è¿›ä¸€æ­¥ä¼˜åŒ–æ€§èƒ½ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®æ¯ç§æ•°æ®åº“ç±»å‹ï¼Œè®¾ç½® **ä¸åŒçš„ tail æ’ä»¶** ï¼Œåœ¨æ¯ä¸ªæ’ä»¶ä¸­ï¼ŒPVCä¹‹åçš„ç›®å½•å®Œå…¨å†™æ­»ï¼Œä¸å‡ºç°ä»»ä½•é€šé…ç¬¦ï¼Œå¯ä»¥å°†è¿™éƒ¨åˆ†çš„æ€§èƒ½æå‡åˆ°æœ€é«˜ï¼Œå½¢å¦‚ï¼š

```
[INPUT]
        Name              tail
        Tag               database.mysql.slow
        Path              /var/lib/kubelet/pods/*/volumes/kubernetes.io~local-volume/*/log/mysqld-slowquery.log
        Path_Key          filepath
        Parser            json
        Mem_Buf_Limit     150MB
        Buffer_Chunk_size 160k
        Buffer_Max_size   160k
        Skip_Long_Lines   On 
    [INPUT]
        Name              tail
        Tag               database.mongodb
        Path              /var/lib/kubelet/pods/*/volumes/kubernetes.io~local-volume/*/logs/mongodb.log
        Path_Key          filepath
        Parser            json
        Mem_Buf_Limit     150MB
        Buffer_Chunk_size 160k
        Buffer_Max_size   160k
        Skip_Long_Lines   On
```

è¿™æ ·æ•°æ®é‡åªæœ‰ podæ•° \* podæŒ‚è½½pvcæ•° \* å…·ä½“logç›®å½•æ•°ï¼ˆä¸ªä½æ•°æ•°é‡çº§ï¼‰ï¼Œä¸å­˜åœ¨ä»»ä½•æ€§èƒ½é—®é¢˜ã€‚

## é—®é¢˜äºŒï¼šé«˜ç²¾åº¦æŸ¥è¯¢

æ—¥å¿—é‡‡é›†åˆ°æ‰‹åï¼Œå¦‚ä½•å®ç°ç²¾å‡†æŸ¥è¯¢æˆäº†æ–°çš„éš¾é¢˜ã€‚æ—¥å¿—è·¯å¾„é‡Œåªæœ‰ `pod id` å’Œ `pvc id` ï¼Œæ²¡æœ‰ namespaceã€æ•°æ®åº“åç§°è¿™äº›å…³é”®ä¿¡æ¯ï¼Œç”¨æˆ·æ ¹æœ¬æ— æ³•æŒ‰åº”ç”¨ç»´åº¦æ£€ç´¢æ—¥å¿—ã€‚æˆ‘ä»¬å°è¯•äº†ä¸¤ç§æ–¹æ¡ˆï¼Œæœ€ç»ˆæ‰¾åˆ°äº†æœ€ä¼˜è§£ã€‚

## æ–¹æ¡ˆä¸€ï¼šé‡‡é›†ä¾§å…ƒæ•°æ®å¢å¼º

å…ƒæ•°æ®å¢å¼ºï¼Œç®€å•æ¥è¯´ï¼Œå°†namespaceï¼Œdatabase nameç­‰å­—æ®µåœ¨æ—¥å¿—å†™å…¥æ—¶ï¼Œä¸€å¹¶å†™å…¥æ—¥å¿—ä¸­ï¼Œä»¥ä¾¿åœ¨ä¹‹åæŸ¥è¯¢æ—¶ä½¿ç”¨ï¼Œè¿™æ˜¯æ—¥å¿—æŸ¥è¯¢çš„ä¼ ç»Ÿæ–¹æ¡ˆã€‚

ç”¨ç¤ºæ„å›¾å¯ä»¥è¡¨ç¤ºå¦‚ä¸‹ï¼š

![Image](https://mp.weixin.qq.com/s/www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg%20stroke='none'%20stroke-width='1'%20fill='none'%20fill-rule='evenodd'%20fill-opacity='0'%3E%3Cg%20transform='translate(-249.000000,%20-126.000000)'%20fill='%23FFFFFF'%3E%3Crect%20x='249'%20y='126'%20width='1'%20height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

åœ¨å…·ä½“å®ç°ä¸Šï¼Œæˆ‘ä»¬åˆ†åˆ«è°ƒç ”äº† **fluentbitï¼Œvectorï¼Œloongcollector** çš„ä¸‰ç§å®ç°æ–¹æ¡ˆï¼Œç”¨è¡¨æ ¼ç®€è¦ä»‹ç»å¦‚ä¸‹ï¼š

| åç§° | å¯è¡Œæ€§ | ä¸å¯è¡ŒåŸå›  | å¼€å‘éš¾åº¦ | æ€§èƒ½ | è¿ç»´æˆæœ¬ | å¤‡æ³¨ |
| --- | --- | --- | --- | --- | --- | --- |
| Fluentbit-åŸç”Ÿæ’ä»¶ | ä¸å¯è¡Œ | æ²¡æœ‰æ ¹æ®Pod Uidå’ŒPVC UIDè¿›è¡Œå…ƒæ•°æ®å¢å¼ºçš„æ’ä»¶ | æ—  | æ—  | ä½ |  |
| Fluentbit-wasmæ’ä»¶ | ä¸å¯è¡Œ | wasmæ’ä»¶æ— æ³•è¿æ¥å¤–éƒ¨ç½‘ç»œ | ä½ | æ—  | ä½ |  |
| Fluentbit-è‡ªå®šä¹‰æ’ä»¶ | ä¸å¯è¡Œ | API Serveræ— æ³•ç›´æ¥æ ¹æ®Pod Uidå’ŒPVC UID æŸ¥è¯¢ | ä¸­ | æ—  | ä½ |  |
| Fluentbit-è‡ªå®šä¹‰æ’ä»¶+ç¼“å­˜ç¨‹åº | å¯è¡Œ |  | é«˜ï¼ˆä¸¤ä¸ªç»„ä»¶ï¼‰ | ä½ï¼ˆæ¯æ¡æ—¥å¿—éƒ½éœ€è¦å‘èµ·è¯·æ±‚ï¼‰ | é«˜ |  |
| Vector-åŸç”Ÿæ’ä»¶ | ä¸å¯è¡Œ | æ²¡æœ‰æ ¹æ®Pod Uidå’ŒPVC UIDè¿›è¡Œå…ƒæ•°æ®å¢å¼ºçš„æ’ä»¶ | æ—  |  | ä½ |  |
| Vector-VRL+ç¼“å­˜ç¨‹åº | å¯è¡Œ |  | ä¸­ | ä½ï¼ˆæ¯æ¡æ—¥å¿—éƒ½éœ€è¦å‘èµ·è¯·æ±‚ï¼‰ | ä¸­ |  |
| LoongCollector-åŸç”Ÿæ’ä»¶ | å¯è¡Œ |  | æ—  | é«˜ | ä¸­ | èµ„æºæ¶ˆè€—å¤§ |

  

  

### 1\. fluent-bit æ–¹æ¡ˆ

#### 1.1 wasmæ’ä»¶

æˆ‘ä»¬é¦–å…ˆå°è¯•äº†å®˜æ–¹æ¨èçš„ **wasmæ’ä»¶** ï¼Œè®¡åˆ’é€šè¿‡æ’ä»¶è§£æpod idï¼Œå†è°ƒç”¨api serverè·å–å…ƒæ•°æ®ã€‚

ä½¿ç”¨å®˜æ–¹æ¨èçš„å¦‚ä¸‹å‡½æ•°ç­¾åè¿›è¡Œå¼€å‘ã€‚

å¼€å‘æŒ‡å—ï¼š **https://docs.fluentbit.io/manual/fluent-bit-for-developers/developer-guide [#filter](https://mp.weixin.qq.com/s/)**

```
//export go_filter
func go_filter(tag *uint8, tag_len uint, time_sec uint, time_nsec uint, record *uint8, record_len uint) *uint8 {
    fmt.Println("=== WASM Filter å¼€å§‹å¤„ç† ===")

    btag := unsafe.Slice(tag, tag_len)
    brecord := unsafe.Slice(record, record_len)
    now := time.Unix(int64(time_sec), int64(time_nsec))

    fmt.Printf("æ¥æ”¶åˆ°çš„æ ‡ç­¾: %s\n", string(btag))
    fmt.Printf("æ¥æ”¶åˆ°çš„è®°å½•é•¿åº¦: %d\n", record_len)
    fmt.Printf("æ—¶é—´æˆ³: %s\n", now.String())

    br := string(brecord)

    var p fastjson.Parser
    value, err := p.Parse(br)
    if err != nil {
       fmt.Printf("âŒ JSON è§£æå¤±è´¥: %v\n", err)
       return nil
    }
    fmt.Println("âœ… JSON è§£ææˆåŠŸ")

    obj, err := value.Object()
    if err != nil {
       fmt.Printf("âŒ è·å– JSON å¯¹è±¡å¤±è´¥: %v\n", err)
       return nil
    }

    // è¾“å‡ºæ‰€æœ‰labels
    extractAndPrintLabels(obj)

    var arena fastjson.Arena
    obj.Set("time", arena.NewString(now.String()))
    obj.Set("tag", arena.NewString(string(btag)))
    obj.Set("original", arena.NewString(br))

    s := obj.String() + string(rune(0))
    rv := []byte(s)

    fmt.Printf("æœ€ç»ˆè¾“å‡ºé•¿åº¦: %d\n", len(rv))
    fmt.Println("=== WASM Filter å¤„ç†å®Œæˆ ===\n")

    return &rv[0]
}
```

ä½¿ç”¨tinygoè¿›è¡Œç¼–è¯‘ï¼Œç¼–è¯‘å‘½ä»¤

```
/tinygo/bin/tinygo build -o wasm-filter.wasm  -target wasi filter.go
```

fluentbitç›¸å…³é…ç½®

```
[FILTER]         
    Name              wasm        
    Match             csi.*         
    WASM_Path         /fluent-bit/wasm/csi-enricher-filter.wasm         
    Function_Name     go_filter         
    accessible_paths  /var/run/secrets
```

å®é™…æµ‹è¯•å‘ç°ï¼Œ **wasmæ’ä»¶æ— æ³•è®¿é—®å¤–éƒ¨ç½‘ç»œ** ï¼Œè¿™ä¸ªæ–¹æ¡ˆåªèƒ½æ”¾å¼ƒã€‚

```
2025-09-10T08:01:25.874Z | è°ƒç”¨API...
2025-09-10T08:01:25.874Z | APIå¤±è´¥: Netdev not set
2025-09-10T08:01:25.954Z | è°ƒç”¨API...
2025-09-10T08:01:25.954Z | APIå¤±è´¥: Netdev not set
2025-09-10T08:01:25.954Z | è°ƒç”¨API...
2025-09-10T08:01:25.954Z | APIå¤±è´¥: Netdev not set
```

#### 1.2 kubernetes filteræ’ä»¶

æ¥ç€æˆ‘ä»¬è€ƒè™‘ **è‡ªç ”fluent-bitåŸç”Ÿæ’ä»¶** ï¼Œå‚è€ƒå®ƒçš„kubernetes filteræ’ä»¶é€»è¾‘ï¼Œç›´æ¥ä¿®æ”¹æºä»£ç å¼€å‘ã€‚ä½†åˆé‡åˆ°äº†æ–°é—®é¢˜ï¼Œä»¥ä¸‹æ˜¯è¿‡ç¨‹ã€‚

ä»£ç ä½äº `fluentbit/plugins/filter_kubernetes/kubernetes.c`

å®ƒæ¥æ”¶åŸå§‹çš„å®¹å™¨æ—¥å¿—ï¼Œç„¶åä¸ºæ¯æ¡æ—¥å¿—è®°å½•æ·»åŠ ä¸°å¯Œçš„Kubernetes ç¯å¢ƒä¿¡æ¯ï¼Œæœ€åè¾“å‡ºå¢å¼ºåçš„ç»“æ„åŒ–æ—¥å¿—ã€‚

å·¥ä½œæµç¨‹ç®€è¦åˆ†æå¦‚ä¸‹ï¼š

- æ’ä»¶å¯åŠ¨å’Œåˆå§‹åŒ–
- æ’ä»¶å¯åŠ¨ï¼šå½“Fluent Bitå¯åŠ¨æ—¶ï¼Œæ’ä»¶é¦–å…ˆè¯»å–é…ç½®æ–‡ä»¶ä¸­çš„å„ç§å‚æ•°ï¼Œæ¯”å¦‚Kubernetes APIæœåŠ¡å™¨åœ°å€ã€è®¤è¯ä»¤ç‰Œæ–‡ä»¶è·¯å¾„ã€æ˜¯å¦å¯ç”¨æ—¥å¿—åˆå¹¶ç­‰é€‰é¡¹ã€‚
	- å»ºç«‹è¿æ¥ï¼šæ’ä»¶ä¸Kubernetes APIæœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼Œå‡†å¤‡è·å– Pod å’Œå‘½åç©ºé—´çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚å¦‚æœé…ç½®äº†kubelet æ¨¡å¼ï¼Œåˆ™è¿æ¥åˆ° kubelet çš„APIç«¯ç‚¹ã€‚
	- åˆå§‹åŒ–ç¼“å­˜ï¼šåˆ›å»ºå†…å­˜ç¼“å­˜ç”¨äºå­˜å‚¨å·²è·å–çš„å…ƒæ•°æ®ï¼Œé¿å…é‡å¤çš„APIè°ƒç”¨æé«˜æ€§èƒ½ã€‚
- æ—¥å¿—æ¥æ”¶å’Œé¢„å¤„ç†
- æ¥æ”¶æ—¥å¿—æµï¼šæ’ä»¶ä»ä¸Šæ¸¸ï¼ˆé€šå¸¸æ˜¯tailè¾“å…¥æ’ä»¶ï¼‰æ¥æ”¶åŸå§‹çš„å®¹å™¨æ—¥å¿—æ•°æ®ï¼Œè¿™äº›æ—¥å¿—é€šå¸¸åŒ…å«åŸºæœ¬çš„æ—¶é—´æˆ³ã€æ—¥å¿—å†…å®¹å’Œä¸€äº›å®¹å™¨æ ‡è¯†ä¿¡æ¯ã€‚
	- æ ‡ç­¾è§£æï¼šä»æ—¥å¿—çš„æ ‡ç­¾ï¼ˆtagï¼‰ä¸­æå–å®¹å™¨ä¿¡æ¯ï¼Œæ¯”å¦‚Podåç§°ã€å‘½åç©ºé—´ã€å®¹å™¨åç­‰ã€‚è¿™ä¸ªè¿‡ç¨‹ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥è§£ææ ‡ç­¾æ ¼å¼ã€‚
- æ—¥å¿—å†…å®¹å¤„ç†
- æ–°æ’ä»¶ï¼šä»¿ç…§ä¸Šæ–‡ä»‹ç»è¿‡çš„Kubernetes filteræ’ä»¶å¼€å‘ï¼Œ
	- ä»£ç ä½äº **https://github.com/bearslyricattack/fluent-bit/tree/pod-plugin/plugins/filter\_pod**

ç¼–è¯‘

```
cd .. 
rm -rf build 
mkdir build && cd build  

cmake -DFLB_FILTER_POD=On ..  
make -j$(nproc)
```

éªŒè¯

```
./bin/fluent-bit --help
./bin/fluent-bit -c test_config.conf
```

æ„å»ºé•œåƒ

```
docker build --target production -t fluent-bit-test:latest .
```

æµ‹è¯•

```
[SERVICE]
    Flush        1
    Daemon       Off
    Log_Level    info
[INPUT]
    Name dummy
    Tag  test.logs
    Dummy {"message": "æµ‹è¯•æ¶ˆæ¯", "level": "info", "timestamp": "2024-01-01T10:00:00Z"}
    Rate 1
[FILTER]
    Name   test
    Match  *
[OUTPUT]
    Name   stdout
    Match  *
    Format json_lines
```

ç»æµ‹è¯• ï¼Œæ—¥å¿—ç›®å½•ä¸­åªæœ‰ `pod uid` å’Œ `container uid` ï¼Œè€Œ api server å¹¶ä¸æ”¯æŒé€šè¿‡è¿™ä¸¤ä¸ªå­—æ®µæŸ¥è¯¢ pod

![Image](https://mp.weixin.qq.com/s/www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg%20stroke='none'%20stroke-width='1'%20fill='none'%20fill-rule='evenodd'%20fill-opacity='0'%3E%3Cg%20transform='translate(-249.000000,%20-126.000000)'%20fill='%23FFFFFF'%3E%3Crect%20x='249'%20y='126'%20width='1'%20height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

`https://kubernetes.io/docs/concepts/overview/working-with-objects/field-selectors/`

#### 1.3 æ–°æ’ä»¶+Informer

æœ€åæˆ‘ä»¬æƒ³åˆ°äº† â€œ **è‡ªå®šä¹‰æ’ä»¶ + informer ç¼“å­˜æœåŠ¡** â€ çš„ç»„åˆï¼šéƒ¨ç½²ä¸€ä¸ªç‹¬ç«‹çš„ informer serviceï¼Œç¼“å­˜é›†ç¾¤å†…æ•°æ®åº“ pod çš„ä¿¡æ¯ï¼Œæ„å»ºä»¥ pod uid ä¸º key çš„ç´¢å¼•ï¼Œå¹¶æä¾› http æ¥å£ä¾› fluent-bit æ’ä»¶è°ƒç”¨ã€‚

æˆ‘ä»¬å®ç°äº†è¿™æ ·ä¸€ä¸ªinfromer service `https://github.com/bearslyricattack/pod-index`

è¿™ä¸ªæ–¹æ¡ˆå¯è¡Œï¼Œä½†éœ€è¦ç»´æŠ¤ä¸¤ä¸ªç»„ä»¶ï¼Œæ¯æ¡æ—¥å¿—éƒ½è¦å‘èµ·ä¸€æ¬¡è¯·æ±‚ï¼Œ **æ€§èƒ½å’Œè¿ç»´æˆæœ¬éƒ½åé«˜** ã€‚

### 2\. vector æ–¹æ¡ˆ

vector çš„ kubernetes\_logs source æ’ä»¶æ˜¯ä¸º/var/log/podsç›®å½•è®¾è®¡çš„ï¼Œä¸æ”¯æŒæˆ‘ä»¬çš„PVCæ—¥å¿—è·¯å¾„ã€‚æˆ‘ä»¬å°è¯•ç”¨å®ƒçš„ **VRL è¯­è¨€ç»“åˆç¼“å­˜æœåŠ¡** å®ç°å…ƒæ•°æ®å¢å¼ºï¼ŒåŸç†å’Œfluent-bitçš„æ–¹æ¡ˆç±»ä¼¼ï¼ŒåŒæ ·å­˜åœ¨æ¯æ¡æ—¥å¿—éƒ½è¦å‘èµ·è¯·æ±‚çš„æ€§èƒ½é—®é¢˜ã€‚

### 3\. loongcollector æ–¹æ¡ˆ

loongcollectoræºè‡ªé˜¿é‡Œäº‘ilogtailé¡¹ç›®ï¼Œå®ƒçš„æ–‡æœ¬æ—¥å¿—è¾“å…¥æ’ä»¶æ”¯æŒ **å®¹å™¨å‘ç°åŠŸèƒ½** ï¼Œå¼€å¯ EnableContainerDiscovery å‚æ•°åï¼Œèƒ½è‡ªåŠ¨æ„å»º pvc è·¯å¾„ -pod çš„æ˜ å°„å…³ç³»ï¼ŒæŠŠ pod label è‡ªåŠ¨åŠ åˆ°æ—¥å¿—é‡Œï¼Œæ­£å¥½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚

![Image](https://mp.weixin.qq.com/s/www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg%20stroke='none'%20stroke-width='1'%20fill='none'%20fill-rule='evenodd'%20fill-opacity='0'%3E%3Cg%20transform='translate(-249.000000,%20-126.000000)'%20fill='%23FFFFFF'%3E%3Crect%20x='249'%20y='126'%20width='1'%20height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

![Image](https://mp.weixin.qq.com/s/www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg%20stroke='none'%20stroke-width='1'%20fill='none'%20fill-rule='evenodd'%20fill-opacity='0'%3E%3Cg%20transform='translate(-249.000000,%20-126.000000)'%20fill='%23FFFFFF'%3E%3Crect%20x='249'%20y='126'%20width='1'%20height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

- ä½†å®ƒä¹Ÿæœ‰ä¸¤ä¸ªè‡´å‘½ç¼ºç‚¹ï¼š
- ä¸€æ˜¯éœ€è¦æŒ‚è½½èŠ‚ç‚¹çš„/var/runå’Œæ ¹ç›®å½•ï¼Œå­˜åœ¨ä¸¥é‡çš„å®‰å…¨é£é™©ï¼›
	- äºŒæ˜¯å®ƒä¼šç¼“å­˜èŠ‚ç‚¹ä¸Šæ‰€æœ‰podçš„ä¿¡æ¯ï¼Œåœ¨å…¬æœ‰äº‘é¢‘ç¹å˜æ›´çš„åœºæ™¯ä¸‹ï¼Œä¼šå¸¦æ¥æ²‰é‡çš„æ€§èƒ½è´Ÿæ‹…ã€‚åŠ ä¸Šæˆ‘ä»¬ç°æœ‰æŠ€æœ¯æ ˆæ˜¯fluent-bitï¼Œæ›´æ¢å·¥å…·çš„è¿ç§»æˆæœ¬å¤ªé«˜ï¼Œæœ€ç»ˆä¹Ÿæ”¾å¼ƒäº†è¿™ä¸ªæ–¹æ¡ˆã€‚

## æ–¹æ¡ˆäºŒï¼šæŸ¥è¯¢ä¾§æ•°æ®è½¬æ¢

æ—¢ç„¶é‡‡é›†ä¾§å¢å¼ºçš„éš¾åº¦å’Œæˆæœ¬éƒ½å¾ˆé«˜ï¼Œæˆ‘ä»¬æ¢äº†ä¸ªæ€è·¯ï¼š **ä¸åœ¨é‡‡é›†ä¾§åšé¢å¤–å·¥ä½œï¼Œè€Œæ˜¯åœ¨æŸ¥è¯¢ä¾§è§£å†³é—®é¢˜** ã€‚

åœ¨æˆ‘ä»¬çš„æ¶æ„ä¸­ï¼Œç”¨æˆ·ä¸ä¼šç›´æ¥è®¿é—®vlogsï¼Œè€Œæ˜¯é€šè¿‡è‡ªç ”çš„ä¸­é—´serviceå‘èµ·è¯·æ±‚ã€‚è¿™ä¸ªserviceæœ¬èº«å°±æ‰¿æ‹…ç€è®¤è¯æˆæƒã€è¯·æ±‚è½¬æ¢çš„åŠŸèƒ½ã€‚æˆ‘ä»¬åªéœ€è¦åœ¨è¿™ä¸ªæœåŠ¡å±‚å¢åŠ ä¸€ä¸ªè½¬æ¢é€»è¾‘ï¼š

1. æ¥æ”¶ç”¨æˆ·ä¼ å…¥çš„pod nameã€namespaceç­‰å‚æ•°ã€‚
2. è°ƒç”¨ api serverï¼Œå°†è¿™äº›å‚æ•°è½¬æ¢æˆå¯¹åº”çš„ pvc uidã€‚
3. ç”¨ pvc uid ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ï¼Œå»vlogsè·å–æ—¥å¿—æ•°æ®ã€‚
4. å°†æŸ¥è¯¢ç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚

è¿™ä¸ªæ–¹æ¡ˆçš„å¦™å¤„åœ¨äºï¼Œæˆ‘ä»¬ç”¨ **pvc uid æ›¿ä»£ pod uid ä½œä¸ºæ—¥å¿—ç´¢å¼•** ã€‚å› ä¸º pod é‡å¯å uid ä¼šå˜åŒ–ï¼Œå¯¼è‡´æ—§æ—¥å¿—å˜æˆ â€œåƒµå°¸æ•°æ®â€ï¼Œè€Œ pvc çš„ç”Ÿå‘½å‘¨æœŸå’Œæ•°æ®åº“ç»‘å®šï¼Œåªè¦æ•°æ®åº“å­˜åœ¨ï¼Œå°±èƒ½é€šè¿‡ pvc uid æŸ¥è¯¢åˆ°å®Œæ•´æ—¥å¿—ã€‚

æ•´ä¸ªæµç¨‹ç”¨ç¤ºæ„å›¾è¡¨ç¤ºå¦‚ä¸‹ï¼š

![Image](https://mp.weixin.qq.com/s/www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg%20stroke='none'%20stroke-width='1'%20fill='none'%20fill-rule='evenodd'%20fill-opacity='0'%3E%3Cg%20transform='translate(-249.000000,%20-126.000000)'%20fill='%23FFFFFF'%3E%3Crect%20x='249'%20y='126'%20width='1'%20height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

æ¯”å¦‚ç”¨æˆ·è¦æŸ¥è¯¢æŸä¸¤ä¸ªPVCçš„æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œæœ€ç»ˆçš„ vlogsql æŸ¥è¯¢è¯­æ³•æ˜¯è¿™æ ·çš„ï¼š

```
{volume_uid=~"pvc-53f9e08d-9ace-4491-955d-4d186de39ac1|pvc-b41b7de2-9b91-43f9-95b3-c062a0e07553"} *keyword* job:in("fluent-bit","redis") type:in("slow","run") | stats by (_time:1%s) count() logs_total
```

è¿™ä¸ªæ–¹æ¡ˆä¸éœ€è¦ä¿®æ”¹é‡‡é›†æµç¨‹ï¼Œä¹Ÿä¸ç”¨ç»´æŠ¤é¢å¤–ç»„ä»¶ï¼Œ **å®Œç¾è§£å†³äº†é«˜ç²¾åº¦æŸ¥è¯¢çš„é—®é¢˜** ã€‚

## é—®é¢˜ä¸‰ï¼šé«˜å¯ç”¨å»ºè®¾

åœ¨äº‘åŸç”Ÿç¯å¢ƒä¸­ï¼ŒæœåŠ¡é‡å¯æ˜¯å¸¸æ€ã€‚æˆ‘ä»¬ä» **æ•°æ®åº“é‡å¯ã€fluent-bit é‡å¯ã€æ—¥å¿—å­˜å‚¨æœåŠ¡é‡å¯** ä¸‰ä¸ªç»´åº¦ï¼Œè®¾è®¡äº†å®Œæ•´çš„é«˜å¯ç”¨ä¿éšœæœºåˆ¶ã€‚

## æ•°æ®åº“é‡å¯ï¼šåŸºäºinodeå’Œdev\_idé¿å…é‡å¤ä¸ä¸¢å¤±

è¦ä¿è¯æ•°æ®åº“é‡å¯æ—¶æ—¥å¿—ä¸ä¸¢å¤±ã€ä¸é‡å¤ï¼Œé¦–å…ˆè¦ææ‡‚ **fluent-bit tail æ’ä»¶çš„ç¼“å­˜æœºåˆ¶** ã€‚

ç”±äºæ²¡æœ‰å¾ˆå¥½çš„ä»‹ç»è¿™éƒ¨åˆ†é€»è¾‘çš„æ–‡ç« ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ä½¿ç”¨claude codeå¸®åŠ©æˆ‘ä»¬åˆ†æä»£ç ã€‚

![Image](https://mp.weixin.qq.com/s/www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg%20stroke='none'%20stroke-width='1'%20fill='none'%20fill-rule='evenodd'%20fill-opacity='0'%3E%3Cg%20transform='translate(-249.000000,%20-126.000000)'%20fill='%23FFFFFF'%3E%3Crect%20x='249'%20y='126'%20width='1'%20height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

é€šè¿‡åˆ†æ fluentbit çš„æºä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ **Fluent Bit çš„ tail æ’ä»¶ä½¿ç”¨æ•°æ®åº“ ä½œä¸ºæŒä¹…åŒ–å­˜å‚¨æ¥ç¼“å­˜æ–‡ä»¶è¯»å–ä½ç½®** ã€‚

æ ¸å¿ƒæ•°æ®ç»“æ„åœ¨plugins/in\_tail/tail\_sql.h å¯ä»¥çœ‹åˆ°ï¼š

```
CREATE TABLE IF NOT EXISTS in_tail_files (
    id      INTEGER PRIMARY KEY,    -- è‡ªå¢ä¸»é”®
    name    TEXT NOT NULL,          -- æ–‡ä»¶å
    offset  INTEGER,                -- è¯»å–åç§»é‡
    inode   INTEGER,                -- inode å·ï¼ˆæ ¸å¿ƒç´¢å¼•ï¼‰
    created INTEGER,                -- åˆ›å»ºæ—¶é—´æˆ³
    rotated INTEGER DEFAULT 0       -- è½®è½¬æ ‡è®°ï¼ˆ0=æœªè½®è½¬ï¼Œ1=å·²è½®è½¬ï¼‰
)
```

æ•°æ®åº“é‡å¯åï¼ŒPVCæ²¡æœ‰å˜åŒ–ï¼Œæ—¥å¿—æ–‡ä»¶çš„ inode ä¹Ÿä¸ä¼šå˜ï¼Œfluent-bit ä¼šæ ¹æ®å­˜å‚¨çš„ offset ç»§ç»­é‡‡é›†ï¼Œä¸ä¼šé‡å¤ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚

è€ƒè™‘åˆ° kubernetes ç¯å¢ƒä¸­ä¸åŒå®¹å™¨å¯èƒ½å‡ºç°inodeç›¸åŒçš„æƒ…å†µï¼Œæˆ‘ä»¬è¿˜å¼€å¯äº† **dev\_id å’Œ inode ç»„åˆæ ‡è¯†** ï¼ŒåŒæ—¶å¯ç”¨ **compare\_filename é…ç½®** ï¼Œåœ¨è¯†åˆ«inodeæ—¶æ ¡éªŒæ–‡ä»¶åï¼Œè¿›ä¸€æ­¥é¿å…äº† inode é‡ç”¨çš„é—®é¢˜ã€‚

## fluent-bit é‡å¯ï¼šå¼€å¯offsetæŒä¹…åŒ–

é»˜è®¤æƒ…å†µä¸‹ï¼Œfluent-bit çš„ offset ä¿¡æ¯å­˜åœ¨å†…å­˜ä¸­ï¼Œpodé‡å¯åå°±ä¼šä¸¢å¤±ã€‚æˆ‘ä»¬é€šè¿‡ **é…ç½® offset æŒä¹…åŒ–** è§£å†³è¿™ä¸ªé—®é¢˜ï¼šå°†offsetä¿¡æ¯å†™å…¥ç£ç›˜ï¼Œå¹¶è®¾ç½® **DB.Sync ä¸º Normal** ï¼Œè®©æ•°æ®å®šæœŸåŒæ­¥åˆ°ç£ç›˜ï¼Œå¹³è¡¡æ€§èƒ½å’Œæ•°æ®å®‰å…¨æ€§ã€‚

è¿™æ ·é…ç½®åï¼Œå³ä½¿fluent-bité‡å¯ï¼Œä¹Ÿèƒ½ä»ç£ç›˜ä¸­è¯»å–ä¹‹å‰çš„offsetï¼Œç»§ç»­é‡‡é›†æ—¥å¿—ã€‚

ä»¥ä¸€ä¸ªmysqlé”™è¯¯æ—¥å¿—çš„é‡‡é›†é…ç½®ä¸ºä¾‹ï¼š

```
[INPUT]
    Name tail
    Tag  database.mysql.error
    Path           /var/lib/kubelet/pods/*/volumes/kubernetes.io~csi/*/mount/log/mysqlderror.log
    Path_Key          filepath

    DB /var/lib/fluent-bit/tail.db
    DB.Sync normal
    DB.journal_mode WAL
    DB.Locking on
    DB.Compare_Filename on
    
    Refresh_Interval 5
    
    Mem_Buf_Limit     150MB
    Buffer_Chunk_size 160k
    Buffer_Max_size   160k
    Skip_Long_Lines   On
```

## æ—¥å¿—å­˜å‚¨æœåŠ¡é‡å¯ï¼šå¤šå‰¯æœ¬éƒ¨ç½²å®ç°é«˜å¯ç”¨

æˆ‘ä»¬çš„æ—¥å¿—å­˜å‚¨æœåŠ¡é‡‡ç”¨ **å¤šå‰¯æœ¬éƒ¨ç½²çš„ Victoria Logs** ã€‚å½“éƒ¨åˆ†vlstorageèŠ‚ç‚¹ä¸å¯ç”¨æ—¶ï¼Œvlinsertä¼šè‡ªåŠ¨å°†æ—¥å¿—å†™å…¥ä»ç„¶å¯ç”¨çš„vlstorageï¼Œç¡®ä¿æ—¥å¿—æ•°æ®ä¸ä¼šä¸¢å¤±ã€‚

## æ€»ç»“

ä¼ ç»Ÿçš„ Sidecaræ–¹æ¡ˆè™½ç„¶åŠŸèƒ½å¼ºå¤§ï¼Œèƒ½å¤Ÿè½»æ¾æ”¶é›†åˆ°æ—¥å¿—ï¼Œä½†åœ¨äº‘è®¡ç®—ç¯å¢ƒä¸‹å­˜åœ¨ **æ˜æ˜¾çš„å±€é™æ€§** ï¼šæ¯ä¸ªæ•°æ®åº“å®ä¾‹éƒ½éœ€è¦ç‹¬ç«‹çš„ Sidecarå®¹å™¨ï¼Œåœ¨å¤§è§„æ¨¡é›†ç¾¤ä¸­ä¼šå¸¦æ¥ **æ˜¾è‘—çš„CPUå’Œå†…å­˜æ¶ˆè€—** ï¼›éœ€è¦ç»´æŠ¤å¤§é‡çš„ Sidecarå®ä¾‹ï¼Œ **å¢åŠ äº†è¿ç»´è´Ÿæ‹…å’Œæ•…éšœæ’æŸ¥éš¾åº¦** ï¼›ç”¨æˆ·éœ€è¦ç†è§£å’Œé…ç½® Sidecarçš„å„ç§å‚æ•°ï¼Œ **å­¦ä¹ æˆæœ¬è¾ƒé«˜** ã€‚

åŸºäºä»¥ä¸Šç—›ç‚¹ï¼Œæˆ‘ä»¬è®¾è®¡äº†è¿™å¥— **åŸºäºDaemonSet + ä¸»æœºè·¯å¾„æŒ‚è½½ + äºŒæ¬¡æŸ¥è¯¢çš„æ–°æ–¹æ¡ˆ** ã€‚é€šè¿‡æ·±å…¥åˆ†æ **Fluent Bit tailæ’ä»¶å’ŒGNU libc globå‡½æ•°çš„åº•å±‚å®ç°** ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº† **é«˜æ€§èƒ½çš„æ–‡ä»¶åŒ¹é…ç­–ç•¥** ï¼›é€šè¿‡ **æŸ¥è¯¢ä¾§æ•°æ®è½¬æ¢** çš„è®¾è®¡ï¼Œé¿å…äº†é‡‡é›†ä¾§å¤æ‚çš„å…ƒæ•°æ®å¢å¼ºé€»è¾‘ï¼›é€šè¿‡å®Œå–„çš„ **æŒä¹…åŒ–æœºåˆ¶** ï¼Œä¿éšœäº†æ—¥å¿—é‡‡é›†çš„é«˜å¯ç”¨æ€§ã€‚

è¿™å¥—æ–¹æ¡ˆåœ¨ä¿è¯åŠŸèƒ½å®Œæ•´æ€§çš„åŒæ—¶ï¼Œå®ç°äº† **æ›´ä½çš„èµ„æºæ¶ˆè€—** ï¼ˆå•èŠ‚ç‚¹ä¸€ä¸ªé‡‡é›†å™¨æœåŠ¡æ‰€æœ‰æ•°æ®åº“å®ä¾‹ï¼‰ã€ **æ›´ç®€å•çš„ç®¡æ§** ï¼ˆç»Ÿä¸€çš„é…ç½®ç®¡ç†å’Œæ•…éšœå¤„ç†ï¼‰ä»¥åŠ **æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ** ï¼ˆå¯¹ç”¨æˆ·é€æ˜ï¼Œæ— éœ€é¢å¤–é…ç½®ï¼‰ã€‚

æœªæ¥æˆ‘ä»¬è¿˜å°†æŒç»­ä¼˜åŒ–è¿™å¥—æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ **è¿›ä¸€æ­¥ä¼˜åŒ–globåŒ¹é…æ€§èƒ½ã€æ¢ç´¢æ›´è½»é‡çº§çš„å…ƒæ•°æ®å¢å¼ºæ–¹æ¡ˆã€å¢å¼ºæ—¥å¿—æŸ¥è¯¢çš„çµæ´»æ€§å’Œç²¾å‡†åº¦** ç­‰æ–¹å‘ï¼Œå¸Œæœ›èƒ½ä¸ºäº‘è®¡ç®—ç¯å¢ƒä¸‹çš„æ•°æ®åº“æ—¥å¿—æ”¶é›†æä¾›æ–°çš„æ€è·¯å’Œå‚è€ƒã€‚

  

ï¼ˆ å…¨æ–‡å®Œ ï¼‰

ğŸ„ ğŸ â›„ï¸ ğŸ§‘ğŸ„

---

å…³äº Sealos

**Sealos æ˜¯ä¸€æ¬¾ä»¥ Kubernetes ä¸ºå†…æ ¸çš„äº‘æ“ä½œç³»ç»Ÿå‘è¡Œç‰ˆã€‚å®ƒä»¥äº‘åŸç”Ÿçš„æ–¹å¼ï¼ŒæŠ›å¼ƒäº†ä¼ ç»Ÿçš„äº‘è®¡ç®—æ¶æ„ï¼Œè½¬å‘ä»¥ Kubernetes ä¸ºäº‘å†…æ ¸çš„æ–°æ¶æ„ï¼Œä½¿ä¼ä¸šèƒ½å¤Ÿåƒä½¿ç”¨ä¸ªäººç”µè„‘ä¸€æ ·ç®€å•åœ°ä½¿ç”¨äº‘ã€‚**

å…³æ³¨ Sealos å…¬ä¼—å·ä¸æˆ‘ä»¬ä¸€åŒæˆé•¿ ï½

  

ä¿®æ”¹äº 2025å¹´12æœˆ25æ—¥

ç»§ç»­æ»‘åŠ¨çœ‹ä¸‹ä¸€ä¸ª

Sealos

å‘ä¸Šæ»‘åŠ¨çœ‹ä¸‹ä¸€ä¸ª