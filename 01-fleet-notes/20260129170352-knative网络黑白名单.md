---
tags:
  - knative
id: 20260129170403
created: 2026-01-29 17:04:03
status:
  - in_progress
type: fleet-note
aliases:
  - knative网络黑白名单
---

用 Istio 做 Knative Service（KService）Pod 的 **出网白名单**，推荐组合：

1. 让 KService 的 Revision Pod **进到 Istio data plane**（sidecar 或 ambient）
    
2. 用 **REGISTRY_ONLY + ServiceEntry** 把“允许访问的外部域名/端口”显式注册
    
3. 如需更强约束（防绕过/统一审计），再把所有出网 **强制走 Egress Gateway**，并用 **K8s NetworkPolicy/节点防火墙**兜底
    

---

## 0) 前提：KService 的 Pod 必须被 Istio 接管

Istio 的 egress 控制（REGISTRY_ONLY、ServiceEntry）只对被 Envoy 拦截的流量有效（sidecar/ambient）。否则还是直接从 Pod 网卡出去了。

常见做法（sidecar 模式）：

- 给租户 namespace 打：`istio-injection=enabled`
    
- 或在 KService 的 `spec.template.metadata.labels` 里加：`sidecar.istio.io/inject: "true"`（按 Revision 生效） ([Istio](https://istio.io/latest/docs/reference/config/annotations/?utm_source=chatgpt.com "Resource Annotations"))
    

---

## 1) 在租户 namespace 做“默认阻断出网”，仅允许已登记外部服务

### 1.1 用 REGISTRY_ONLY（优先用 **Sidecar 资源做 namespace 级覆盖**）

Istio 文档说明：meshConfig 的 `outboundTrafficPolicy.mode` 可设为 `REGISTRY_ONLY`，且可被 `Sidecar` 级别覆盖。 ([Istio](https://istio.io/latest/docs/tasks/traffic-management/egress/egress-control/?utm_source=chatgpt.com "Accessing External Services"))

**namespace 级（推荐，避免全局改动）：**

```yaml
apiVersion: networking.istio.io/v1beta1
kind: Sidecar
metadata:
  name: tenant-egress
  namespace: tenant-a
spec:
  outboundTrafficPolicy:
    mode: REGISTRY_ONLY
```

效果：该 namespace 中被网格接管的工作负载，访问**任何未在 Istio registry 中声明**的外部 host 都会被 Envoy 拦截阻断。 ([Istio](https://istio.io/latest/docs/tasks/traffic-management/egress/egress-control/?utm_source=chatgpt.com "Accessing External Services"))

---

## 2) 把“允许访问的外部 HTTP(S) 接口”用 ServiceEntry 白名单化

`ServiceEntry` 用于把外部服务（DNS 名、端口、解析方式等）加入 Istio registry。 ([Istio](https://istio.io/latest/docs/reference/config/networking/service-entry/?utm_source=chatgpt.com "Service Entry"))

### 2.1 允许访问某个外部 HTTPS 域名（示例）

```yaml
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: allow-api-example
  namespace: tenant-a
spec:
  hosts:
  - api.example.com
  location: MESH_EXTERNAL
  ports:
  - number: 443
    name: tls-443
    protocol: TLS
  resolution: DNS
```

注意点：

- `resolution: DNS` 是常见安全做法；Istio 文档也指出把 resolution 设为 `NONE` 会引入通过伪造 Host header 等方式绕过的风险。 ([Istio](https://istio.io/latest/docs/tasks/traffic-management/egress/egress-control/?utm_source=chatgpt.com "Accessing External Services"))
    
- 如果你需要放行 `*.example.com` 这种一组域名，可用 Istio 的 wildcard egress host 配置思路降低维护成本。 ([Istio](https://istio.io/latest/docs/tasks/traffic-management/egress/wildcard-egress-hosts/?utm_source=chatgpt.com "Egress using Wildcard Hosts"))
    

---

## 3) 更强的“强制出网走统一出口”：Egress Gateway +（NetworkPolicy/防火墙）

仅靠 sidecar 的拦截属于“应用侧代理控制”，要做到更强的“不可绕过”，Istio 官方建议：**通过 Egress Gateway 集中出口**，并结合 **NetworkPolicy** 强制应用只能连 egress gateway，这样即使绕过 sidecar 也会被底层网络挡住。 ([Istio](https://istio.io/latest/docs/ops/best-practices/security/?utm_source=chatgpt.com "Security Best Practices"))

典型组成（高层逻辑）：

1. `ServiceEntry`：声明允许的外部 host
    
2. `Gateway`：定义 egress gateway 的监听
    
3. `VirtualService`：把到外部 host 的流量路由到 egress gateway
    
4. （可选）`DestinationRule`：TLS/SNI 等策略
    
5. K8s `NetworkPolicy`：在 tenant namespace **只允许 Pod 出站到 egress gateway（+DNS）**（从网络层兜底）
    

---

## 4) 你要的“只能访问某些白名单外部 HTTP 接口”到底能细到什么粒度

- **按域名/端口**：REGISTRY_ONLY + ServiceEntry 能做到（推荐路径）。 ([Istio](https://istio.io/latest/docs/tasks/traffic-management/egress/egress-control/?utm_source=chatgpt.com "Accessing External Services"))
    
- **按 URL 路径/方法（真正的 HTTP 接口级白名单）**：需要在 **Egress Gateway/外置代理** 上做 L7 规则（Istio/Envoy 能做，但配置复杂度更高），REGISTRY_ONLY/ServiceEntry 本身不是用来做路径级 ACL 的。
    

---

## 5) Knative 相关的一个容易踩坑点

如果你额外启用了 Istio 的 `AuthorizationPolicy` 做访问控制，要确保 Knative 系统组件（如 activator/autoscaler）仍可访问你的服务；Knative 文档有专门说明需要放行这些系统 Pod 的访问。 ([Knative](https://knative.dev/docs/serving/istio-authorization/?utm_source=chatgpt.com "Istio Authorization"))

---

如果你给出两项信息，我可以把 YAML 直接拼成可用的最小闭环（含 DNS 放行、按 KService label 精确匹配、以及 egress gateway 强制路由）：

1. Istio 是 **sidecar** 还是 **ambient**
    
2. 你的白名单是 **固定域名列表** 还是 **通配域名**，以及端口（80/443/自定义）

# References